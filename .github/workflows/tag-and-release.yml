name: Tag and Release on Merge

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    # CIが成功したときのみ実行
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write  # タグのpushに必要
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check version and create tag
        id: tag_check
        run: |
          # Get version from pyproject.toml
          VERSION=$(grep -m1 '^version = ' pyproject.toml | cut -d'"' -f2)
          TAG="v$VERSION"
          
          echo "Detected version: $VERSION"
          echo "Target tag: $TAG"

          # Check if tag exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            echo "create_tag=false" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG does not exist. Creating."
            echo "create_tag=true" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.tag_check.outputs.create_tag == 'true'
        run: |
          TAG="${{ steps.tag_check.outputs.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
